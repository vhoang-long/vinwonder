<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Giỏ vé trò chơi VinWonders</title>
    <link rel="icon" type="image/png" href="/assets/iconlogo.png" />
    <link rel="stylesheet" href="game-cart.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <button class="back-btn" onclick="window.history.back()">
        <i class="fa-solid fa-arrow-left"></i>
      </button>
      <h2>Giỏ vé trò chơi</h2>
      <div style="width: 40px"></div>
    </header>

    <!-- Toast notification -->
    <div id="toast" class="toast">
      <i class="fa-solid fa-circle-exclamation"></i>
      <span id="toastMessage"></span>
    </div>

    <div class="container">
      <div id="cartList" class="cart-list"></div>
      <div id="emptyCart" class="empty-cart" style="display: none">
        <i class="fa-solid fa-cart-shopping"></i>
        Chưa có vé nào trong giỏ
      </div>
    </div>

    <script>
      // Lấy dữ liệu từ localStorage
      function getGameCart() {
        return JSON.parse(localStorage.getItem("gameCart")) || [];
      }

      // Hiển thị toast notification
      function showToast(message) {
        const toast = document.getElementById("toast");
        const toastMessage = document.getElementById("toastMessage");
        toastMessage.textContent = message;
        toast.classList.add("show");
        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      // Xóa item khỏi giỏ
      function removeCartItem(index) {
        const cart = getGameCart();
        console.log("[DEBUG] Cart from localStorage:", cart);
        cart.splice(index, 1);
        localStorage.setItem("gameCart", JSON.stringify(cart));
        renderGameCart();
        showToast("Đã xóa vé khỏi giỏ hàng!");
      }

      function renderGameCart() {
        const cart = getGameCart();
        const cartList = document.getElementById("cartList");
        const emptyCart = document.getElementById("emptyCart");

        cartList.innerHTML = "";

        if (cart.length === 0) {
          emptyCart.style.display = "";
          return;
        }

        emptyCart.style.display = "none";

        cart.forEach((item, index) => {
          const div = document.createElement("div");
          div.className = "cart-item";

          const typeClass = item.ticketType === "hangao" ? "virtual" : "";
          const typeText =
            item.ticketType === "hangao" ? "Hàng ảo" : "Vé ưu tiên";

          let namesHTML = "";
          if (item.names && item.names.length > 0) {
            namesHTML = `<div class="names">${item.names.map((n, i) => `<span>${i + 1}. ${n}</span>`).join("")}</div>`;
          }

          const priceHTML = item.price
            ? `<div class="price">${item.price.toLocaleString("vi-VN")} đ</div>`
            : "";

          div.innerHTML = `
            <img src="${item.image}" alt="${item.name}" style="width: 40%; height: auto;"/>
            <div class="cart-info">
              <div class="type ${typeClass}">${typeText}</div>
              <h4>${item.name}</h4>
${item.time ? `<div class="time"><i class="fa-regular fa-clock"></i> ${item.time}</div>` : ""}
              <div class="players"><i class="fa-solid fa-user-group"></i> ${item.count} người</div>
              <div class="order">Thứ tự: <b>${item.order}</b></div>
              ${namesHTML}
              ${priceHTML}
            </div>
            <button class="remove-btn" onclick="removeCartItem(${index})" title="Xóa vé">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          `;

          cartList.appendChild(div);
        });
      }

      // Expose removeCartItem globally
      window.removeCartItem = removeCartItem;

      window.addEventListener("storage", renderGameCart);
      renderGameCart();
    </script>
  </body>
</html>
